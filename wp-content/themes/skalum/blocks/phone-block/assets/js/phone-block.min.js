const cvs=document.getElementById("pushes"),ctx=cvs.getContext("2d"),BASE=window.SkalumPhoneBlock&&window.SkalumPhoneBlock.imgBase||"/wp-content/themes/skalum/blocks/phone-block/assets/images/",ASSETS={bg:BASE+"iphone.png",cards:["push_1.png","push_2.png","push_3.png","push_4.png"].map(t=>BASE+t)},LAYOUT={stackX:.075,stackY:.52,cardW:.85,gap:10,rows:3},TIMING={arrivalEveryMs:3600,pushPxPerMs:.12,damping:.095,settlePx:.9,growFrom:.9,growOvershoot:.16,growSpeed:.003,constraintsIters:3,TICK_MS:1500};function fitDPR(){const t=Math.max(1,window.devicePixelRatio||1),e=parseInt(getComputedStyle(cvs).width,10),n=parseInt(getComputedStyle(cvs).height,10);cvs.width=Math.round(e*t),cvs.height=Math.round(n*t),ctx.setTransform(t,0,0,t,0,0)}fitDPR(),addEventListener("resize",fitDPR);const load=t=>new Promise(e=>{const n=new Image;n.onload=()=>e(n),n.onerror=()=>e(null),n.src=t});!async function(){const t=await load(ASSETS.bg),e=(await Promise.all(ASSETS.cards.map(load))).filter(Boolean);if(!t||0===e.length)return;const n=e[0].naturalWidth,o=e[0].naturalHeight;function a(){const t=parseInt(getComputedStyle(cvs).width,10),e=parseInt(getComputedStyle(cvs).height,10),a=Math.round(t*LAYOUT.cardW),s=a/n,r=Math.round(o*s),i=Math.round(t*LAYOUT.stackX),c=Math.round(e*LAYOUT.stackY);return{W:t,H:e,cardW:a,cardH:r,x:i,yTop:c,screenBottom:c+(r+LAYOUT.gap)*LAYOUT.rows-LAYOUT.gap}}let s=a();addEventListener("resize",()=>{fitDPR(),s=a()});const r=t=>s.yTop+t*(s.cardH+LAYOUT.gap);let i=1,c=e.slice(0,LAYOUT.rows).map((t,e)=>({id:i++,img:t,y:r(e),vy:0,s:1,a:1})),l=LAYOUT.rows%e.length,d=!1,g=performance.now()-TIMING.arrivalEveryMs+500,h=0;const u={slot1Id:null,slot2Id:null};function m(){u.slot1Id=u.slot2Id=null}function I(t,e){h=Math.max(h,e+t)}let p=performance.now();requestAnimationFrame(function n(o){const a=Math.min(50,o-p);if(p=o,!d&&o-g>=TIMING.arrivalEveryMs&&(g=o,d||0===c.length||(d=!0,m(),c[0].vy+=16*TIMING.pushPxPerMs)),d){if(o<h)for(const t of c)t.vy*=.85;else c[0].vy+=TIMING.pushPxPerMs*a;for(const t of c)t.y+=t.vy,t.vy*=1-TIMING.damping;!function(){for(let t=0;t<TIMING.constraintsIters;t++)for(let t=0;t<c.length-1;t++){const e=c[t],n=c[t+1],o=s.cardH+LAYOUT.gap-(n.y-e.y);if(o>0){const t=.5*o;e.y-=t,n.y+=t,n.vy+=.35*e.vy}}}(),c[0]&&c[0].id!==u.slot1Id&&c[0].y>=r(1)-2&&(u.slot1Id=c[0].id,I(TIMING.TICK_MS,o)),c[1]&&c[1].id!==u.slot2Id&&c[1].y>=r(2)-2&&(u.slot2Id=c[1].id,I(TIMING.TICK_MS,o)),function(){if(d&&c[0].y>=r(1)&&!c.some(t=>t.__growing)){const t=e[l++%e.length];c.unshift({id:i++,img:t,y:r(0),vy:0,s:TIMING.growFrom,a:0,__growing:!0}),u.slot1Id=null}}(),function(t){const e=c[0];if(!e||!e.__growing)return;const n=e.s<1+TIMING.growOvershoot?1+TIMING.growOvershoot:1;e.s+=(n-e.s)*(TIMING.growSpeed*t),e.a+=(1-e.a)*(TIMING.growSpeed*t*.9),Math.abs(e.s-1)<.01&&(e.s=1,e.a=1,e.__growing=!1)}(a),function(){if(!c.slice(0,LAYOUT.rows).every((t,e)=>Math.abs(t.y-r(e))<.08*s.cardH&&Math.abs(t.vy)<.04))return;let t=!1;c=c.filter((e,n)=>!(e.y>=s.screenBottom&&!t&&n>=LAYOUT.rows&&(t=!0,1))),!t&&c.length<=LAYOUT.rows&&c.slice(0,LAYOUT.rows).every((t,e)=>Math.abs(t.y-r(e))<TIMING.settlePx&&Math.abs(t.vy)<.02&&!t.__growing)&&(d=!1,m())}()}!function(){ctx.clearRect(0,0,cvs.width,cvs.height),ctx.drawImage(t,0,0,t.naturalWidth,t.naturalHeight,0,0,s.W,s.H);let e=null,n=1/0;for(const t of c){const o=Math.abs(t.y-r(0));o<n&&(n=o,e=t)}const o=[...c].sort((t,e)=>t.y-e.y);for(const t of o){const n=s.cardW*t.s,o=s.cardH*t.s,a=s.x+(s.cardW-n)/2,r=Math.round(t.y)+(s.cardH-o)/2;ctx.globalAlpha=t===e?1:.92*t.a,ctx.drawImage(t.img,0,0,t.img.naturalWidth,t.img.naturalHeight,a,r,n,o)}ctx.globalAlpha=1;const a=.5*s.H,i=ctx.createLinearGradient(0,s.H-a,0,s.H);i.addColorStop(0,"rgba(0,0,0,0)"),i.addColorStop(1,"rgba(0,0,0,0.9)"),ctx.fillStyle=i,ctx.fillRect(0,s.H-a,s.W,a)}(),requestAnimationFrame(n)})}(),function(){const t=document.getElementById("phone_time"),e=document.getElementById("phone_date"),n="en-GB",o=new Intl.DateTimeFormat(n,{weekday:"long"}),a=new Intl.DateTimeFormat(n,{month:"long"});function s(){const n=new Date;var s;t.textContent=`${((s=n).getHours()+11)%12+1}:${s.getMinutes().toString().padStart(2,"0")}`,e.textContent=function(t){return`${o.format(t)}, ${t.getDate()} ${a.format(t)}`}(n)}s(),function(){const t=new Date,e=1e3*(60-t.getSeconds())-t.getMilliseconds();setTimeout(()=>{s(),setInterval(s,6e4)},Math.max(0,e))}(),document.addEventListener("visibilitychange",()=>{document.hidden||s()})}();